import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signOut,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signInWithCustomToken
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  addDoc, 
  updateDoc, 
  onSnapshot,
  Timestamp,
  increment,
  deleteDoc,
  query,
  orderBy
} from 'firebase/firestore';
import { getStorage, ref, uploadBytes, getDownloadURL } from 'firebase/storage';
import { 
  LayoutDashboard, 
  Package, 
  ShoppingCart, 
  Receipt, 
  Scale, 
  BarChart3, 
  Settings as SettingsIcon,
  Plus,
  ChevronRight,
  TrendingUp,
  LogOut,
  X,
  Menu,
  Coffee,
  Calculator,
  BookOpen,
  Trash2,
  Save,
  AlertTriangle,
  CheckCircle2,
  FileText
} from 'lucide-react';
import {
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  BarChart,
  Bar,
  AreaChart,
  Area
} from 'recharts';

// --- CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyB8EE6iavqDKXJdmgLpOD6kMVYsskHu56w",
  authDomain: "kmy-bru-manager.firebaseapp.com",
  projectId: "kmy-bru-manager",
  storageBucket: "kmy-bru-manager.firebasestorage.app",
  messagingSenderId: "176073299379",
  appId: "1:176073299379:web:6c5eeee23008d8f09b27c6"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
const appId = "kmy-bru-final-v1"; 

const THEME = {
  bg: 'bg-[#050505]',
  card: 'bg-[#0c0c0c] border border-[#1a1a1a]',
  input: 'bg-[#000] border-[#222] focus:border-white focus:ring-1 focus:ring-white text-white placeholder:text-zinc-800',
  accent: 'bg-white text-black'
};

const formatRM = (val) => new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR' }).format(val || 0);
const formatUnit = (qty, unit) => {
  if (unit === 'ml' && qty >= 1000) return `${(qty / 1000).toFixed(2)}L`;
  if (unit === 'g' && qty >= 1000) return `${(qty / 1000).toFixed(2)}kg`;
  return `${qty}${unit}`;
};

// --- COMPONENTS ---

const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[100] flex justify-center items-start overflow-y-auto bg-black/95 backdrop-blur-md p-4 py-10 lg:py-20 animate-in fade-in duration-300">
      <div className="fixed inset-0 -z-10" onClick={onClose} />
      <div className={`${THEME.card} relative w-full max-w-xl rounded-[2.5rem] shadow-2xl animate-in zoom-in-95 duration-300 my-auto overflow-hidden`}>
        <div className="flex items-center justify-between p-6 lg:p-10 border-b border-[#1a1a1a] sticky top-0 bg-[#0c0c0c] z-10">
          <h3 className="text-xl font-black tracking-widest uppercase italic text-white leading-none">{title}</h3>
          <button onClick={onClose} className="p-3 hover:bg-white/10 rounded-full transition-all text-white/40 hover:text-white"><X size={24} /></button>
        </div>
        <div className="p-6 lg:p-10 text-white">{children}</div>
      </div>
    </div>
  );
};

// --- MAIN APP ---
export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState('dashboard');
  const [sidebarOpen, setSidebarOpen] = useState(false);
  
  const [products, setProducts] = useState([]);
  const [ingredients, setIngredients] = useState([]);
  const [recipes, setRecipes] = useState([]);
  const [sales, setSales] = useState([]);
  const [purchases, setPurchases] = useState([]);
  const [settings, setSettings] = useState({ autoDeduct: true, watermark: true, logoUrl: null });

  // Auth Handling with Error Resilience
  useEffect(() => {
    let isMounted = true;
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token).catch(() => {});
        }
      } catch (e) { console.error("Initial token error", e); }
    };

    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => { 
      if (isMounted) {
        setUser(u); 
        setLoading(false); 
      }
    });

    // Safety timeout: if auth takes too long, stop loading to show login page
    const timeout = setTimeout(() => { if (isMounted) setLoading(false); }, 3000);

    return () => {
      isMounted = false;
      unsubscribe();
      clearTimeout(timeout);
    };
  }, []);

  // Data Sync
  useEffect(() => {
    if (!user) return;
    const base = ['artifacts', appId, 'users', user.uid];
    const unsub = [
      onSnapshot(collection(db, ...base, 'products'), s => setProducts(s.docs.map(d => ({id: d.id, ...d.data()})))),
      onSnapshot(collection(db, ...base, 'ingredients'), s => setIngredients(s.docs.map(d => ({id: d.id, ...d.data()})))),
      onSnapshot(collection(db, ...base, 'recipes'), s => setRecipes(s.docs.map(d => ({id: d.id, ...d.data()})))),
      onSnapshot(collection(db, ...base, 'sales'), s => setSales(s.docs.map(d => ({id: d.id, ...d.data()})))),
      onSnapshot(collection(db, ...base, 'purchases'), s => setPurchases(s.docs.map(d => ({id: d.id, ...d.data()})))),
      onSnapshot(doc(db, ...base, 'settings', 'config'), s => s.exists() && setSettings(s.data()))
    ];
    return () => unsub.forEach(f => f());
  }, [user]);

  if (loading) return (
    <div className="min-h-screen bg-black flex flex-col items-center justify-center text-white">
      <div className="w-12 h-12 border-t-2 border-white rounded-full animate-spin mb-6"></div>
      <p className="font-black italic tracking-[0.5em] uppercase text-[10px] opacity-30">KMY BRU • SYNCHRONIZING</p>
    </div>
  );

  if (!user) return <AuthPage />;

  const NavItem = ({ icon: Icon, label, id }) => (
    <button 
      onClick={() => { setView(id); setSidebarOpen(false); }}
      className={`flex items-center space-x-4 px-6 py-4 rounded-2xl transition-all w-full text-left ${view === id ? 'bg-white text-black font-black shadow-2xl scale-[1.03]' : 'text-zinc-600 hover:text-white hover:bg-zinc-900'}`}
    >
      <Icon size={18} strokeWidth={view === id ? 3 : 2} />
      <span className="text-[10px] tracking-[0.3em] uppercase font-bold">{label}</span>
    </button>
  );

  return (
    <div className={`min-h-screen w-full ${THEME.bg} text-white font-sans flex flex-col lg:flex-row overflow-x-hidden selection:bg-white selection:text-black`}>
      {/* Watermark */}
      {settings.watermark && settings.logoUrl && (
        <div className="fixed inset-0 pointer-events-none opacity-[0.03] flex items-center justify-center grayscale invert z-0 overflow-hidden">
          <img src={settings.logoUrl} className="w-[80vw] max-w-4xl transform rotate-[-15deg]" alt="" />
        </div>
      )}

      {/* Desktop Sidebar */}
      <aside className="hidden lg:flex flex-col w-72 fixed h-full border-r border-[#1a1a1a] p-8 z-[60] bg-black">
        <div className="mb-14 flex items-center space-x-4">
          <div className="w-10 h-10 bg-white rounded-xl flex items-center justify-center rotate-3 shadow-xl">
            <Coffee className="text-black" size={24} />
          </div>
          <div>
            <h1 className="text-xl font-black italic tracking-tighter uppercase">KMY BRU</h1>
            <span className="text-[9px] uppercase tracking-[0.4em] text-zinc-600 font-bold">MANAGEMENT</span>
          </div>
        </div>
        <nav className="flex-1 space-y-3">
          <NavItem icon={LayoutDashboard} label="Dashboard" id="dashboard" />
          <NavItem icon={ShoppingCart} label="Jualan" id="sales" />
          <NavItem icon={BookOpen} label="Menu & Resipi" id="products" />
          <NavItem icon={Package} label="Inventori" id="inventory" />
          <NavItem icon={Receipt} label="Pembelian" id="purchases" />
          <NavItem icon={Scale} label="Scaler" id="recipes" />
          <NavItem icon={BarChart3} label="Analitik" id="reports" />
          <NavItem icon={SettingsIcon} label="Tetapan" id="settings" />
        </nav>
        <button onClick={() => signOut(auth)} className="mt-10 flex items-center space-x-3 p-5 text-zinc-700 hover:text-red-500 transition-colors border-t border-zinc-900 font-black uppercase text-[10px] tracking-widest">
          <LogOut size={16} /> <span>Sign Out</span>
        </button>
      </aside>

      {/* Mobile Top Header */}
      <header className="lg:hidden flex items-center justify-between p-6 border-b border-[#1a1a1a] sticky top-0 bg-black/95 backdrop-blur-xl z-[60] w-full">
        <div className="flex items-center space-x-4">
          <div className="p-2 bg-white rounded-lg"><Coffee className="text-black" size={20} /></div>
          <h1 className="font-black italic tracking-tighter text-xl text-white uppercase">KMY BRU</h1>
        </div>
        <button onClick={() => setSidebarOpen(true)} className="p-3 bg-zinc-900 rounded-2xl text-white"><Menu size={24} /></button>
      </header>

      {/* Mobile Drawer */}
      {sidebarOpen && (
        <div className="lg:hidden fixed inset-0 bg-black z-[200] p-8 flex flex-col animate-in slide-in-from-right duration-300 overflow-y-auto">
          <div className="flex justify-between items-center mb-12 flex-shrink-0 border-b border-zinc-900 pb-8">
             <h1 className="text-2xl font-black italic tracking-tighter text-white uppercase">SISTEM MENU</h1>
             <button onClick={() => setSidebarOpen(false)} className="p-3 bg-zinc-900 rounded-2xl text-white"><X size={24} /></button>
          </div>
          <nav className="flex-1 space-y-4">
            <NavItem icon={LayoutDashboard} label="Dashboard" id="dashboard" />
            <NavItem icon={ShoppingCart} label="Jualan" id="sales" />
            <NavItem icon={BookOpen} label="Menu & Resipi" id="products" />
            <NavItem icon={Package} label="Inventori" id="inventory" />
            <NavItem icon={Receipt} label="Pembelian" id="purchases" />
            <NavItem icon={Scale} label="Scaler" id="recipes" />
            <NavItem icon={BarChart3} label="Analitik" id="reports" />
            <NavItem icon={SettingsIcon} label="Tetapan" id="settings" />
          </nav>
        </div>
      )}

      {/* Main View Area */}
      <main className="lg:ml-80 flex-1 p-6 lg:p-16 relative z-10 pb-40 min-h-screen">
        <div className="max-w-6xl mx-auto h-full">
          {view === 'dashboard' && <Dashboard sales={sales} />}
          {view === 'sales' && <SalesPage user={user} sales={sales} products={products} ingredients={ingredients} recipes={recipes} settings={settings} />}
          {view === 'products' && <ProductsPage user={user} products={products} ingredients={ingredients} recipes={recipes} />}
          {view === 'inventory' && <InventoryPage user={user} ingredients={ingredients} />}
          {view === 'purchases' && <PurchasesPage user={user} purchases={purchases} ingredients={ingredients} />}
          {view === 'recipes' && <RecipePage user={user} recipes={recipes} products={products} ingredients={ingredients} />}
          {view === 'reports' && <ReportsPage sales={sales} />}
          {view === 'settings' && <SettingsPage user={user} settings={settings} />}
        </div>
      </main>
    </div>
  );
}

// --- SUB-VIEWS ---

function Dashboard({ sales }) {
  const stats = useMemo(() => {
    const profit = sales.reduce((acc, s) => acc + (s.totalProfit || 0), 0);
    const revenue = sales.reduce((acc, s) => acc + (s.totalPrice || 0), 0);
    return { profit, revenue, count: sales.length };
  }, [sales]);

  return (
    <div className="space-y-12 animate-in fade-in duration-1000 text-white">
      <header><p className="text-zinc-600 uppercase tracking-[0.5em] text-[10px] font-black mb-4 italic opacity-50 uppercase">Operational Overview</p><h2 className="text-6xl font-black tracking-tighter uppercase italic leading-none">STATISTIK</h2></header>
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-8 text-white">
        <StatCard label="Keuntungan Bersih" value={formatRM(stats.profit)} icon={TrendingUp} color="emerald" />
        <StatCard label="Jumlah Hasil" value={formatRM(stats.revenue)} icon={Receipt} color="white" />
        <StatCard label="Bil. Jualan" value={stats.count} icon={ShoppingCart} color="zinc" />
      </div>
      <div className={`${THEME.card} p-12 rounded-[3.5rem] h-[32rem] shadow-2xl`}>
          <h3 className="text-[10px] font-black uppercase tracking-[0.4em] text-zinc-600 mb-12 flex items-center gap-3 italic uppercase">Aktiviti Jualan Semasa</h3>
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={sales.slice(-14)}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#1a1a1a" />
              <XAxis dataKey="timestamp" hide />
              <Tooltip cursor={{fill: '#111'}} contentStyle={{ backgroundColor: '#000', border: '1px solid #222', borderRadius: '30px' }} />
              <Bar dataKey="totalPrice" fill="#fff" radius={[10, 10, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
      </div>
    </div>
  );
}

const StatCard = ({ label, value, icon: Icon, color }) => (
  <div className={`${THEME.card} p-10 rounded-[3rem] relative overflow-hidden group hover:scale-[1.03] transition-all shadow-xl`}>
    <Icon className="absolute top-10 right-10 text-zinc-900 opacity-20 group-hover:opacity-40 transition-opacity" size={72} />
    <p className="text-zinc-600 text-[10px] font-black uppercase tracking-[0.4em] mb-6 italic uppercase">{label}</p>
    <h4 className={`text-4xl font-black tracking-tighter ${color === 'emerald' ? 'text-emerald-500' : 'text-white'}`}>{value}</h4>
  </div>
);

function SalesPage({ user, sales, products, ingredients, recipes, settings }) {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const saveSale = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const pId = formData.get('pId');
    const qty = parseInt(formData.get('qty')) || 0;
    const product = products.find(p => p.id === pId);
    const recipe = recipes.find(r => r.productId === pId);
    if (!product) return;
    let cost = 0;
    if (recipe) recipe.ingredients.forEach(ri => {
      const ing = ingredients.find(i => i.id === ri.ingredientId);
      if (ing) cost += (ri.quantityPerBottle * (ing.avgUnitCostRM || 0));
    });
    const revenue = qty * product.price;
    const totalCost = qty * cost;
    const data = { productName: product.name, quantitySold: qty, totalPrice: revenue, totalCost, totalProfit: revenue - totalCost, timestamp: Timestamp.now() };
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'sales'), data);
      if (settings.autoDeduct && recipe) {
        for (const ri of recipe.ingredients) {
          await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'ingredients', ri.ingredientId), { currentStock: increment(-(ri.quantityPerBottle * qty)) });
        }
      }
      setIsModalOpen(false);
    } catch (err) { console.error(err); }
  };

  return (
    <div className="space-y-12 animate-in fade-in duration-700">
      <header className="flex flex-col sm:flex-row sm:items-end justify-between gap-8 text-white">
        <div><p className="text-zinc-600 uppercase tracking-[0.5em] text-[10px] font-black mb-3 italic opacity-40 uppercase">Transactions</p><h2 className="text-5xl font-black tracking-tighter uppercase leading-none italic uppercase">REKOD JUALAN</h2></div>
        <button onClick={() => setIsModalOpen(true)} className="bg-white text-black px-12 py-5 rounded-[1.5rem] text-[10px] font-black flex items-center justify-center space-x-4 active:scale-95 shadow-2xl transition-all uppercase tracking-widest italic font-black uppercase tracking-widest leading-none"><Plus size={18} strokeWidth={3} /> <span>Daftar Jualan</span></button>
      </header>
      <div className={`${THEME.card} rounded-[3.5rem] overflow-hidden shadow-2xl`}>
        <div className="overflow-x-auto text-white">
          <table className="w-full text-left text-sm text-white">
            <thead>
              <tr className="border-b border-[#1f1f1f] text-zinc-600 uppercase text-[11px] bg-zinc-900/50 font-black tracking-[0.3em]">
                <th className="px-12 py-10">Produk / Waktu</th>
                <th className="px-12 py-10 text-center">Unit</th>
                <th className="px-12 py-10 text-right uppercase">Keuntungan</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[#161616]">
              {sales.sort((a,b) => b.timestamp - a.timestamp).map(s => (
                <tr key={s.id} className="hover:bg-white/[0.02] transition-colors group text-white italic">
                  <td className="px-12 py-12">
                    <div className="font-black text-2xl uppercase tracking-tighter mb-2 leading-none uppercase">{s.productName}</div>
                    <div className="text-[10px] text-zinc-700 font-bold uppercase tracking-widest italic leading-none">{s.timestamp?.toDate().toLocaleString()}</div>
                  </td>
                  <td className="px-12 py-12 text-center font-mono font-black text-3xl tracking-tighter group-hover:scale-110 transition-transform text-white italic">{s.quantitySold}</td>
                  <td className="px-12 py-12 text-right font-mono font-black text-3xl text-emerald-500 tracking-tighter leading-none italic">{formatRM(s.totalProfit)}</td>
                </tr>
              ))}
              {sales.length === 0 && <tr><td colSpan="3" className="px-12 py-40 text-center text-zinc-800 font-black tracking-[0.5em] italic uppercase uppercase italic">Tiada Rekod Jualan</td></tr>}
            </tbody>
          </table>
        </div>
      </div>
      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Pendaftaran Pesanan">
        <form onSubmit={saveSale} className="space-y-12">
          <div className="space-y-4"><label className="text-[10px] font-black uppercase text-zinc-600 italic tracking-widest uppercase">Pilih Item Jualan</label>
          <select name="pId" required className={`w-full ${THEME.input} rounded-[2rem] px-8 py-6 text-sm font-black uppercase outline-none shadow-2xl text-white italic tracking-widest`}>
             <option value="" className="text-zinc-800 font-bold uppercase italic">SILA PILIH...</option>
             {products.map(p => <option key={p.id} value={p.id} className="text-zinc-800 font-bold uppercase">{p.name} ({formatRM(p.price)})</option>)}
          </select></div>
          <div className="space-y-4 text-center"><label className="text-[10px] font-black uppercase text-zinc-600 italic tracking-widest block mb-4 italic uppercase">Bilangan Kuantiti</label>
          <input name="qty" type="number" defaultValue={1} min={1} required className={`w-full bg-transparent border-b-2 border-zinc-900 focus:border-white p-6 text-7xl font-black outline-none font-mono text-white text-center shadow-inner leading-none italic uppercase`} /></div>
          <button type="submit" className="w-full bg-white text-black font-black py-8 rounded-[2.5rem] shadow-2xl uppercase text-[11px] tracking-[0.5em] active:scale-95 transition-all font-black italic uppercase leading-none">Sahkan Pesanan</button>
        </form>
      </Modal>
    </div>
  );
}

function ProductsPage({ user, products, ingredients, recipes }) {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isRecipeModalOpen, setIsRecipeModalOpen] = useState(false);
  const [editingProduct, setEditingProduct] = useState(null);
  const [activeRecipe, setActiveRecipe] = useState(null);

  const saveProduct = async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = { name: formData.get('name').toUpperCase(), volume: parseFloat(formData.get('volume')), price: parseFloat(formData.get('price')), active: true };
    try {
      const base = ['artifacts', appId, 'users', user.uid, 'products'];
      if (editingProduct) await updateDoc(doc(db, ...base, editingProduct.id), data);
      else await addDoc(collection(db, ...base), data);
      setIsModalOpen(false);
    } catch (err) { console.error(err); }
  };

  return (
    <div className="space-y-12 animate-in fade-in duration-700 text-white">
      <header className="flex flex-col sm:flex-row sm:items-end justify-between gap-8">
        <div><p className="text-zinc-600 uppercase tracking-[0.5em] text-[10px] font-black mb-3 italic opacity-40 uppercase">Inventory</p><h2 className="text-5xl font-black tracking-tighter uppercase leading-none italic uppercase italic">MENU & FORMULA</h2></div>
        <button onClick={() => { setEditingProduct(null); setIsModalOpen(true); }} className="bg-white text-black px-12 py-5 rounded-[1.5rem] text-[10px] font-black flex items-center justify-center space-x-4 shadow-2xl transition-all uppercase tracking-widest italic font-black uppercase tracking-widest"><Plus size={18} strokeWidth={3} /> <span>Tambah Produk</span></button>
      </header>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10">
        {products.map(p => (
          <div key={p.id} className={`${THEME.card} p-12 rounded-[3.5rem] space-y-10 hover:border-white transition-all shadow-2xl group relative text-white uppercase italic`}>
            <div className="flex justify-between items-center text-white">
              <div className="p-5 bg-zinc-900 rounded-3xl shadow-inner group-hover:bg-white group-hover:text-black transition-all rotate-3"><Coffee size={28} /></div>
              <div className="flex gap-3">
                <button onClick={() => { 
                  const r = recipes.find(r => r.productId === p.id) || { productId: p.id, ingredients: [] };
                  setActiveRecipe(r);
                  setIsRecipeModalOpen(true);
                }} className="p-4 bg-zinc-900 hover:bg-white hover:text-black rounded-2xl transition-all shadow-xl"><BookOpen size={20} /></button>
                <button onClick={async () => { if(confirm('Hapus produk ini?')) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'products', p.id)) }} className="p-4 bg-zinc-900 hover:bg-rose-500 hover:text-white rounded-2xl transition-all shadow-xl"><Trash2 size={20} /></button>
              </div>
            </div>
            <div>
              <h4 className="font-black text-2xl tracking-tighter uppercase mb-2 italic leading-tight text-white">{p.name}</h4>
              <p className="text-[11px] text-zinc-600 font-bold tracking-[0.3em] uppercase leading-none italic">{p.volume}ml • {formatRM(p.price)}</p>
            </div>
          </div>
        ))}
      </div>
      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Profil Produk">
        <form onSubmit={saveProduct} className="space-y-10 text-white italic">
          <div className="space-y-3 text-white"><label className="text-[10px] font-black uppercase text-zinc-600 italic tracking-widest uppercase">Nama Item</label>
          <input name="name" defaultValue={editingProduct?.name} required placeholder="CONTOH: KOPI LATTE" className={`w-full ${THEME.input} rounded-[2.5rem] px-10 py-7 text-sm font-black uppercase outline-none shadow-2xl text-white italic tracking-widest leading-none shadow-inner`} /></div>
          <div className="grid grid-cols-2 gap-8 text-white text-center italic">
            <div className="space-y-3"><label className="text-[10px] font-black uppercase text-zinc-600 italic tracking-widest text-center block leading-none italic uppercase">Saiz (ml)</label>
            <input name="volume" type="number" defaultValue={editingProduct?.volume || 250} required className={`w-full ${THEME.input} rounded-[2rem] px-8 py-6 text-xl font-mono font-black outline-none text-center shadow-inner uppercase italic leading-none`} /></div>
            <div className="space-y-3"><label className="text-[10px] font-black uppercase text-zinc-600 italic tracking-widest text-center block leading-none italic uppercase">Harga (RM)</label>
            <input name="price" type="number" step="0.1" defaultValue={editingProduct?.price || 10} required className={`w-full ${THEME.input} rounded-[2rem] px-8 py-6 text-xl font-mono font-black outline-none text-center shadow-inner uppercase italic leading-none`} /></div>
          </div>
          <button type="submit" className="w-full bg-white text-black font-black py-8 rounded-[2.5rem] shadow-2xl uppercase text-[11px] tracking-[0.5em] active:scale-95 transition-all italic leading-none font-black uppercase tracking-widest">Simpan Data Menu</button>
        </form>
      </Modal>
      <Modal isOpen={isRecipeModalOpen} onClose={() => setIsRecipeModalOpen(false)} title="Penyelarasan Formula">
        <div className="space-y-12 text-white italic">
           <div className="space-y-4 text-white"><label className="text-[11px] font-black uppercase text-zinc-600 italic tracking-widest italic uppercase tracking-[0.4em]">Bahan Mentah</label>
              <select onChange={async (e) => {
                const ingId = e.target.value; if(!ingId) return;
                const ing = ingredients.find(i => i.id === ingId);
                const updated = { ...activeRecipe, ingredients: [...activeRecipe.ingredients, { ingredientId: ingId, name: ing.name, quantityPerBottle: 0, unit: ing.unit }] };
                setActiveRecipe(updated);
                const base = ['artifacts', appId, 'users', user.uid, 'recipes'];
                if(activeRecipe.id) await updateDoc(doc(db, ...base, activeRecipe.id), updated);
                else { const ref = await addDoc(collection(db, ...base), updated); setActiveRecipe({...updated, id: ref.id}); }
              }} className={`w-full ${THEME.input} rounded-[2.5rem] px-8 py-7 text-xs font-black uppercase outline-none shadow-2xl text-white italic tracking-widest font-black uppercase italic leading-none`}>
                 <option value="" className="text-zinc-800 font-bold uppercase italic tracking-widest leading-none">TAMBAH BAHAN...</option>
                 {ingredients.map(i => <option key={i.id} value={i.id} className="text-zinc-800 font-bold uppercase italic tracking-widest leading-none">{i.name} ({i.unit})</option>)}
              </select>
           </div>
           <div className="space-y-6 max-h-[40vh] overflow-y-auto pr-4 custom-scrollbar text-white italic">
              {activeRecipe?.ingredients.map(ri => (
                <div key={ri.ingredientId} className="flex items-center gap-8 bg-zinc-900/40 p-8 rounded-[3rem] border border-zinc-800 transition-all hover:border-white shadow-inner text-white group italic shadow-xl">
                   <div className="flex-1">
                      <p className="text-[11px] font-black uppercase tracking-[0.4em] mb-4 italic leading-none uppercase italic text-zinc-500 group-hover:text-white transition-colors">{ri.name}</p>
                      <div className="flex items-center gap-4 text-white">
                         <input type="number" value={ri.quantityPerBottle} step="0.1" 
                            onChange={(e) => {
                              const val = parseFloat(e.target.value) || 0;
                              setActiveRecipe({ ...activeRecipe, ingredients: activeRecipe.ingredients.map(i => i.ingredientId === ri.ingredientId ? { ...i, quantityPerBottle: val } : i) });
                            }}
                            className="w-32 bg-black border border-zinc-800 rounded-2xl px-5 py-4 text-lg font-mono font-black text-white outline-none focus:border-white shadow-2xl text-center italic leading-none uppercase font-black italic tracking-tighter" />
                         <span className="text-[10px] font-black text-zinc-600 uppercase tracking-widest italic">{ri.unit} / UNIT</span>
                      </div>
                   </div>
                   <button onClick={() => setActiveRecipe({...activeRecipe, ingredients: activeRecipe.ingredients.filter(i => i.ingredientId !== ri.ingredientId)})} className="p-4 text-zinc-700 hover:text-rose-500 transition-all shadow-xl rounded-full bg-black/20 group-hover:scale-110 shadow-2xl"><Trash2 size={24} /></button>
                </div>
              ))}
           </div>
           <button onClick={async () => { if (activeRecipe.id) await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'recipes', activeRecipe.id), activeRecipe); setIsRecipeModalOpen(false); }} className="w-full bg-white text-black font-black py-8 rounded-[2.5rem] uppercase text-[11px] tracking-[0.5em] shadow-2xl active:scale-95 transition-all leading-none italic font-black uppercase italic tracking-widest leading-none shadow-white/10">Simpan Formula</button>
        </div>
      </Modal>
    </div>
  );
}

function InventoryPage({ user, ingredients }) {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingIng, setEditingIng] = useState(null);
  return (
    <div className="space-y-12 animate-in fade-in duration-700 text-white italic">
      <header className="flex justify-between items-end text-white">
        <div><p className="text-zinc-600 uppercase tracking-[0.5em] text-[10px] font-black mb-3 italic opacity-40 uppercase italic tracking-widest leading-none">Storage</p><h2 className="text-5xl font-black tracking-tighter uppercase leading-none text-white italic italic uppercase">INVENTORI</h2></div>
        <button onClick={() => { setEditingIng(null); setIsModalOpen(true); }} className="bg-white text-black px-10 py-5 rounded-[1.5rem] text-[10px] font-black shadow-2xl uppercase tracking-widest font-black italic uppercase italic tracking-widest leading-none"><Plus size={18} strokeWidth={3} /> Bahan Baru</button>
      </header>
      <div className={`${THEME.card} rounded-[3.5rem] overflow-hidden shadow-2xl text-white`}><div className="overflow-x-auto text-white"><table className="w-full text-left text-sm text-white"><thead><tr className="border-b border-[#1f1f1f] text-zinc-600 uppercase text-[11px] tracking-[0.4em] bg-zinc-900/50 font-black italic uppercase tracking-widest leading-none"><th className="px-12 py-10">Bahan Mentah</th><th className="px-12 py-10 text-center">Stok</th><th className="px-12 py-10 text-right font-black tracking-widest uppercase italic leading-none">Kos Purata</th></tr></thead><tbody className="divide-y divide-[#161616]">
        {ingredients.map(i => (
          <tr key={i.id} className="hover:bg-white/[0.01] transition-colors group text-white italic"><td className="px-12 py-12"><div className="font-black text-2xl uppercase tracking-tighter mb-2 italic leading-none text-white">{i.name}</div><div className="text-[10px] text-zinc-700 font-bold uppercase tracking-widest leading-none italic uppercase">{i.category}</div></td><td className="px-12 py-12 text-center font-mono font-black text-3xl tracking-widest leading-none italic text-white uppercase italic">{formatUnit(i.currentStock, i.unit)}</td><td className="px-12 py-12 text-right font-mono font-black text-xl text-zinc-600 italic tracking-tighter leading-none italic text-zinc-500">{formatRM(i.avgUnitCostRM)}/u</td></tr>
        ))}</tbody></table></div></div>
      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Pangkalan Bahan Mentah"><form onSubmit={async (e) => { e.preventDefault(); const f = new FormData(e.target); const d = { name: f.get('n').toUpperCase(), category: f.get('c'), unit: f.get('u'), currentStock: parseFloat(f.get('s')) || 0, avgUnitCostRM: parseFloat(f.get('k')) || 0 }; const base = ['artifacts', appId, 'users', user.uid, 'ingredients']; if (editingIng) await updateDoc(doc(db, ...base, editingIng.id), d); else await addDoc(collection(db, ...base), d); setIsModalOpen(false); }} className="space-y-12 text-white italic"><input name="n" defaultValue={editingIng?.name} required placeholder="NAMA BAHAN" className={`w-full ${THEME.input} rounded-[2rem] px-10 py-7 font-black uppercase text-sm shadow-2xl outline-none italic uppercase font-black italic tracking-widest leading-none shadow-inner`} /><div className="grid grid-cols-2 gap-8 text-white italic"><select name="c" defaultValue={editingIng?.category || 'raw'} className={`w-full ${THEME.input} rounded-[2rem] px-8 py-6 font-black text-xs outline-none text-white font-black italic shadow-inner uppercase tracking-widest italic font-black uppercase`}><option value="raw" className="text-zinc-800">RAW MATERIAL</option><option value="packaging" className="text-zinc-800">PACKAGING</option></select><select name="u" defaultValue={editingIng?.unit || 'ml'} className={`w-full ${THEME.input} rounded-[2rem] px-8 py-6 font-black text-xs outline-none text-white font-black italic shadow-inner uppercase tracking-widest italic font-black uppercase`}><option value="ml" className="text-zinc-800">ML</option><option value="g" className="text-zinc-800">G</option><option value="pcs" className="text-zinc-800">PCS</option></select></div><div className="grid grid-cols-2 gap-8 text-white italic"><input name="s" type="number" defaultValue={editingIng?.currentStock || 0} step="0.01" placeholder="STOK" className={`w-full ${THEME.input} rounded-[2rem] px-8 py-6 font-mono font-black text-xl text-center italic outline-none shadow-inner uppercase italic leading-none`} /><input name="k" type="number" defaultValue={editingIng?.avgUnitCostRM || 0} step="0.0001" placeholder="KOS" className={`w-full ${THEME.input} rounded-[2rem] px-8 py-6 font-mono font-black text-xl text-center italic outline-none shadow-inner uppercase italic leading-none`} /></div><button type="submit" className="w-full bg-white text-black font-black py-8 rounded-[2rem] uppercase tracking-[0.5em] text-[11px] shadow-2xl transition-all font-black italic leading-none uppercase shadow-white/10">Sahkan Bahan</button></form></Modal>
    </div>
  );
}

function PurchasesPage({ user, purchases, ingredients }) {
  const [isModalOpen, setIsModalOpen] = useState(false);
  return (
    <div className="space-y-12 animate-in fade-in duration-700 text-white italic">
      <header className="flex justify-between items-end text-white">
        <div><p className="text-zinc-600 uppercase tracking-[0.5em] text-[10px] font-black mb-3 italic opacity-40 uppercase italic tracking-widest leading-none">Injections</p><h2 className="text-5xl font-black tracking-tighter uppercase leading-none italic text-white uppercase italic italic uppercase">PEMBELIAN</h2></div>
        <button onClick={() => setIsModalOpen(true)} className="bg-white text-black px-12 py-5 rounded-[1.5rem] text-[10px] font-black shadow-2xl uppercase tracking-widest italic font-black uppercase tracking-widest leading-none italic uppercase"><Plus size={18} strokeWidth={3} /> Log Belian</button>
      </header>
      <div className={`${THEME.card} rounded-[3.5rem] overflow-hidden text-white shadow-2xl`}><div className="overflow-x-auto text-white"><table className="w-full text-left text-sm text-white"><thead><tr className="border-b border-[#1f1f1f] text-zinc-600 uppercase text-[11px] bg-zinc-900/50 font-black tracking-[0.4em] italic uppercase tracking-widest leading-none"><th className="px-12 py-10">Tarikh</th><th className="px-12 py-10">Bahan Belian</th><th className="px-12 py-10 text-right uppercase font-black italic">Jumlah Kos</th></tr></thead><tbody className="divide-y divide-[#161616]">
        {purchases.sort((a,b) => b.timestamp - a.timestamp).map(p => (
          <tr key={p.id} className="hover:bg-white/[0.01] transition-colors group text-white italic"><td className="px-12 py-12 font-mono text-zinc-700 text-[11px] font-black italic uppercase tracking-widest leading-none text-zinc-500">{p.timestamp?.toDate().toLocaleDateString()}</td><td className="px-12 py-12 font-black text-2xl uppercase tracking-tighter leading-none italic text-white uppercase">{p.ingName} <span className="text-[10px] text-zinc-700 font-bold ml-4 uppercase opacity-50 not-italic uppercase tracking-widest italic leading-none">({formatUnit(p.qty, p.unit)})</span></td><td className="px-12 py-12 text-right font-mono font-black text-3xl text-white tracking-tighter leading-none italic text-white">{formatRM(p.cost)}</td></tr>
        ))}</tbody></table></div></div>
      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Log Belian Baru"><form onSubmit={async (e) => { e.preventDefault(); const f = new FormData(e.target); const iId = f.get('id'); const q = parseFloat(f.get('q')); const c = parseFloat(f.get('c')); const ing = ingredients.find(i => i.id === iId); if (!ing) return; const nS = ing.currentStock + q; const nA = (ing.currentStock * ing.avgUnitCostRM + c) / nS; const base = ['artifacts', appId, 'users', user.uid]; await addDoc(collection(db, ...base, 'purchases'), { ingName: ing.name, qty: q, cost: c, unit: ing.unit, timestamp: Timestamp.now() }); await updateDoc(doc(db, ...base, 'ingredients', iId), { currentStock: increment(q), avgUnitCostRM: nA }); setIsModalOpen(false); }} className="space-y-12 text-white italic"><div className="space-y-4 text-white"><label className="text-[10px] font-black uppercase text-zinc-600 italic tracking-widest italic uppercase tracking-widest leading-none uppercase italic">Pilih Bahan Inventori</label><select name="id" required className={`w-full ${THEME.input} rounded-[2rem] px-8 py-6 text-xs font-black uppercase outline-none shadow-2xl text-white italic tracking-widest font-black uppercase italic leading-none shadow-inner`}><option value="" className="text-zinc-800 font-bold uppercase italic tracking-widest leading-none">PILIH BAHAN...</option>{ingredients.map(i => <option key={i.id} value={i.id} className="text-zinc-800 font-bold uppercase italic tracking-widest leading-none">{i.name} ({i.unit})</option>)}</select></div><div className="grid grid-cols-2 gap-8 text-white italic"><div className="space-y-4 text-center italic"><label className="text-[10px] font-black uppercase text-zinc-600 italic tracking-widest block leading-none italic uppercase tracking-widest leading-none uppercase">Kuantiti</label><input name="q" type="number" step="0.01" placeholder="0.00" className={`w-full ${THEME.input} rounded-[2rem] px-8 py-6 text-2xl font-mono font-black text-center shadow-inner outline-none italic text-white uppercase leading-none italic tracking-tighter`} /></div><div className="space-y-4 text-center italic"><label className="text-[10px] font-black uppercase text-zinc-600 italic tracking-widest block leading-none italic uppercase tracking-widest leading-none uppercase">Total (RM)</label><input name="c" type="number" step="0.01" placeholder="0.00" className={`w-full ${THEME.input} rounded-[2rem] px-8 py-6 text-2xl font-mono font-black text-center shadow-inner outline-none italic text-white uppercase leading-none italic tracking-tighter`} /></div></div><button type="submit" className="w-full bg-white text-black font-black py-8 rounded-[2rem] uppercase tracking-[0.5em] text-[11px] shadow-2xl active:scale-95 transition-all font-black italic uppercase leading-none shadow-white/10 italic">Daftar Transaksi</button></form></Modal>
    </div>
  );
}

function RecipePage({ user, recipes, products, ingredients }) {
  const [scaleInput, setScaleInput] = useState(1);
  const [scaleMode, setScaleMode] = useState('bottles');
  const [isSetupOpen, setIsSetupOpen] = useState(false);
  const [selectedBaseId, setSelectedBaseId] = useState('');
  const [targetVol, setTargetVol] = useState('');
  const [suggestion, setSuggestion] = useState(null);
  const activeRecipe = recipes[0];
  const calculated = useMemo(() => {
    if (!activeRecipe) return [];
    const multiplier = scaleMode === 'bottles' ? scaleInput : scaleInput / 250;
    return activeRecipe.ingredients.map(ri => {
      const ing = ingredients.find(i => i.id === ri.ingredientId);
      const needed = ri.quantityPerBottle * multiplier;
      return { ...ing, needed, shortage: Math.max(0, needed - (ing?.currentStock || 0)) };
    });
  }, [activeRecipe, scaleInput, scaleMode, ingredients]);

  return (
    <div className="space-y-12 animate-in fade-in duration-700 text-white italic">
      <header className="flex flex-col sm:flex-row sm:items-end justify-between gap-8 text-white italic">
        <div><p className="text-zinc-600 uppercase tracking-[0.5em] text-[10px] font-black mb-3 italic opacity-40 uppercase italic tracking-widest leading-none uppercase italic">Volume Engineering</p><h2 className="text-5xl font-black tracking-tighter uppercase leading-none italic text-white uppercase italic italic uppercase italic">SCALER</h2></div>
        <button onClick={() => setIsSetupOpen(true)} className="bg-white text-black px-12 py-5 rounded-[1.5rem] text-[10px] font-black uppercase tracking-widest shadow-2xl active:scale-95 transition-all italic font-black uppercase tracking-widest leading-none italic uppercase"><Calculator size={18} strokeWidth={3} className="inline mr-2" /> Setup Saiz Baru</button>
      </header>
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-10 text-white italic">
        <div className={`${THEME.card} p-12 rounded-[3.5rem] space-y-12 shadow-2xl text-white italic`}>
          <div className="flex gap-3 p-2 bg-black rounded-3xl border border-zinc-900 shadow-inner text-white italic">
            <button onClick={() => setScaleMode('bottles')} className={`flex-1 py-5 text-[10px] font-black rounded-2xl transition-all ${scaleMode === 'bottles' ? 'bg-zinc-900 text-white shadow-2xl shadow-white/5' : 'text-zinc-800'}`}>BATCH UNIT</button>
            <button onClick={() => setScaleMode('volume')} className={`flex-1 py-5 text-[10px] font-black rounded-2xl transition-all ${scaleMode === 'volume' ? 'bg-zinc-900 text-white shadow-2xl shadow-white/5' : 'text-zinc-800'}`}>TARGET ML</button>
          </div>
          <div className="space-y-6 text-center italic text-white">
             <label className="text-[10px] font-black uppercase text-zinc-600 italic tracking-[0.5em] leading-none block italic uppercase tracking-widest text-zinc-500">Output Sasaran</label>
             <input type="number" value={scaleInput} onChange={e => setScaleInput(e.target.value)} className="w-full bg-transparent border-b-4 border-zinc-900 focus:border-white p-8 text-8xl font-black outline-none font-mono text-white text-center transition-all leading-none italic shadow-inner tracking-tighter uppercase leading-none italic" />
          </div>
        </div>
        <div className="lg:col-span-2 text-white italic">
           <div className={`${THEME.card} rounded-[3.5rem] overflow-hidden shadow-2xl text-white italic`}>
            <table className="w-full text-left text-sm text-white italic">
              <thead><tr className="border-b border-[#1f1f1f] text-zinc-600 uppercase text-[11px] tracking-[0.5em] font-black bg-zinc-900/50 uppercase italic tracking-widest leading-none uppercase italic"><th className="px-12 py-10">Bahan Mentah Utama</th><th className="px-12 py-10 text-right uppercase italic">Sukatan</th><th className="px-12 py-10 text-right uppercase italic font-black">Status</th></tr></thead>
              <tbody className="divide-y divide-[#161616]">
                {calculated.map(item => (
                  <tr key={item.id} className="hover:bg-white/[0.02] transition-colors group text-white italic"><td className="px-12 py-12 font-black text-2xl uppercase tracking-tighter italic leading-none text-zinc-200 group-hover:text-white transition-colors uppercase italic leading-none">{item.name}</td><td className="px-12 py-12 text-right font-mono font-black text-3xl tracking-tighter group-hover:scale-110 transition-transform leading-none text-white italic text-white italic leading-none uppercase">{formatUnit(item.needed, item.unit)}</td><td className="px-12 py-12 text-right">
                      {item.shortage > 0 ? <span className="text-rose-500 font-black text-[10px] bg-rose-500/10 px-8 py-3 rounded-[2rem] border border-rose-500/20 uppercase tracking-[0.4em] shadow-lg animate-pulse leading-none italic font-black uppercase tracking-widest italic leading-none uppercase">Kurang {formatUnit(item.shortage, item.unit)}</span> : <span className="text-emerald-500 font-black text-[11px] uppercase tracking-[0.5em] opacity-40 italic leading-none font-black italic uppercase tracking-widest italic leading-none uppercase tracking-widest">Mencukupi</span>}
                    </td></tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <Modal isOpen={isSetupOpen} onClose={() => { setIsSetupOpen(false); setSuggestion(null); }} title="Formula Saiz Baru (Logic)">
         <div className="space-y-12 text-white italic">
            <div className="space-y-4 text-white italic"><label className="text-[10px] font-black uppercase text-zinc-600 italic tracking-widest italic uppercase tracking-widest leading-none uppercase italic tracking-widest font-black uppercase italic tracking-widest">Rujukan Menu Asal</label>
            <select value={selectedBaseId} onChange={e => setSelectedBaseId(e.target.value)} className={`w-full ${THEME.input} rounded-[2.5rem] px-10 py-7 text-sm font-black uppercase outline-none shadow-2xl text-white italic font-black tracking-widest italic font-black uppercase italic tracking-widest leading-none italic uppercase tracking-widest font-black`}>
               <option value="" className="text-zinc-800 font-bold uppercase italic tracking-widest leading-none uppercase italic">SILA PILIH MENU...</option>
               {products.map(p => <option key={p.id} value={p.id} className="text-zinc-800 font-bold uppercase italic tracking-widest leading-none uppercase italic">{p.name} ({p.volume}ml)</option>)}
            </select></div>
            <div className="space-y-4 text-white italic text-center italic"><label className="text-[10px] font-black uppercase text-zinc-600 italic tracking-widest block leading-none italic uppercase tracking-widest leading-none uppercase italic tracking-widest leading-none uppercase italic tracking-widest leading-none uppercase italic">Volume Baru (ml)</label>
            <input type="number" value={targetVol} onChange={e => setTargetVol(e.target.value)} className={`w-full bg-transparent border-b-2 border-zinc-900 focus:border-white p-8 text-7xl font-black font-mono outline-none text-center shadow-inner uppercase italic text-white leading-none italic tracking-tighter italic font-black uppercase italic tracking-tighter italic leading-none text-white italic`} placeholder="0" /></div>
            <button onClick={() => {
              const baseP = products.find(p => p.id === selectedBaseId);
              const baseR = recipes.find(r => r.productId === selectedBaseId);
              if (baseP && baseR && targetVol) {
                const ratio = parseFloat(targetVol) / baseP.volume;
                setSuggestion(baseR.ingredients.map(ri => ({ ...ri, suggested: (ri.quantityPerBottle * ratio).toFixed(2) })));
              }
            }} className="w-full bg-white text-black font-black py-8 rounded-[2.5rem] uppercase text-[11px] tracking-[0.6em] shadow-[0_20px_60px_rgba(255,255,255,0.15)] active:scale-95 transition-all italic leading-none font-black uppercase tracking-widest italic font-black uppercase italic tracking-widest leading-none uppercase italic shadow-white/10">Kira Formula Baru</button>
            {suggestion && (
              <div className="pt-12 border-t border-zinc-900 space-y-8 animate-in slide-in-from-top-4 duration-700 text-white italic font-black">
                 <h4 className="text-[11px] font-black uppercase tracking-[0.5em] text-emerald-500 italic tracking-widest leading-none italic uppercase tracking-widest leading-loose italic uppercase tracking-widest font-black italic tracking-widest">Hasil Kiraan Nisbah {targetVol}ml:</h4>
                 <div className="grid gap-4 text-white italic">
                    {suggestion.map(s => (
                      <div key={s.ingredientId} className="flex justify-between items-center bg-zinc-900/40 p-8 rounded-[3rem] border border-zinc-800 shadow-inner group hover:border-white transition-colors text-white italic">
                        <span className="text-[12px] font-black uppercase tracking-[0.4em] text-zinc-500 group-hover:text-white transition-colors italic uppercase tracking-widest text-zinc-400 italic font-black uppercase">{s.name}</span>
                        <span className="font-mono font-black text-3xl text-white tracking-tighter leading-none italic italic text-white font-black italic tracking-tighter">{s.suggested}{s.unit}</span>
                      </div>
                    ))}
                 </div>
              </div>
            )}
         </div>
      </Modal>
    </div>
  );
}

function ReportsPage({ sales }) {
  const data = useMemo(() => {
    const map = {};
    sales.forEach(s => {
      const d = new Date(s.timestamp?.toDate()).toLocaleDateString('en-MY', { day: '2-digit', month: 'short' });
      if (!map[d]) map[d] = { date: d, revenue: 0, profit: 0 };
      map[d].revenue += s.totalPrice || 0;
      map[d].profit += s.totalProfit || 0;
    });
    return Object.values(map).reverse().slice(-14);
  }, [sales]);
  return (
    <div className="space-y-12 animate-in fade-in duration-1000 text-white italic font-black">
      <header className="text-white italic"><p className="text-zinc-600 uppercase tracking-[0.5em] text-[10px] font-black mb-3 italic opacity-40 tracking-widest italic leading-none uppercase italic tracking-widest leading-none uppercase">Analysis</p><h2 className="text-6xl font-black tracking-tighter uppercase text-white leading-none italic italic uppercase italic leading-none uppercase italic tracking-tighter italic text-white">LAPORAN</h2></header>
      <div className={`${THEME.card} p-12 lg:p-16 rounded-[4rem] h-[42rem] shadow-2xl relative overflow-hidden group text-white italic`}>
         <div className="absolute top-16 left-16 z-10 font-black uppercase tracking-widest uppercase italic text-zinc-700 tracking-[0.5em] group-hover:text-white transition-colors uppercase leading-none italic font-black uppercase tracking-widest leading-none">Financial Performance (2 Weeks)</div>
         <ResponsiveContainer width="100%" height="100%"><AreaChart data={data} margin={{ top: 140, right: 30, left: -10, bottom: 0 }}><defs><linearGradient id="colorRev" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#fff" stopOpacity={0.15}/><stop offset="95%" stopColor="#fff" stopOpacity={0}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#1a1a1a" /><XAxis dataKey="date" stroke="#333" fontSize={11} axisLine={false} tickLine={false} fontStyle="italic" dy={20} /><YAxis stroke="#333" fontSize={11} axisLine={false} tickLine={false} fontStyle="italic" /><Tooltip contentStyle={{ backgroundColor: '#000', border: '1px solid #333', borderRadius: '40px', fontWeight: 'black', textTransform: 'uppercase', fontSize: '12px', padding: '30px' }} /><Area type="monotone" dataKey="revenue" stroke="#333" fillOpacity={1} fill="url(#colorRev)" strokeWidth={3} /><Area type="monotone" dataKey="profit" stroke="#fff" fillOpacity={0} strokeWidth={6} dot={{fill: '#fff', r: 8, strokeWidth: 0}} /></AreaChart></ResponsiveContainer>
      </div>
    </div>
  );
}

function SettingsPage({ user, settings }) {
  const update = async (k, v) => await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config'), { ...settings, [k]: v }, { merge: true });
  return (
    <div className="max-w-3xl space-y-12 animate-in fade-in duration-1000 text-white italic">
      <header className="text-white italic"><p className="text-zinc-600 uppercase tracking-[0.5em] text-[10px] font-black mb-3 italic text-white/40 tracking-widest uppercase italic leading-none uppercase italic tracking-widest leading-none">Control Panel</p><h2 className="text-6xl font-black tracking-tighter uppercase text-white leading-none italic italic uppercase italic leading-none uppercase italic tracking-tighter italic text-white uppercase italic tracking-tighter italic">TETAPAN</h2></header>
      <div className={`${THEME.card} p-16 rounded-[4rem] space-y-16 text-white shadow-2xl italic`}>
        <div className="flex items-center justify-between gap-12 text-white leading-none group italic"><div className="space-y-3 italic"><h4 className="font-black text-3xl italic uppercase tracking-tighter text-white leading-none group-hover:tracking-normal transition-all italic leading-none uppercase tracking-widest font-black uppercase italic leading-none italic tracking-tighter italic">Auto-Deduct Stok</h4><p className="text-[11px] text-zinc-600 font-bold uppercase tracking-[0.3em] italic leading-relaxed tracking-widest max-w-sm italic uppercase tracking-widest opacity-60 italic leading-relaxed tracking-widest">Penolakan stok bahan mentah secara automatik setiap kali order disahkan.</p></div><button onClick={() => update('autoDeduct', !settings.autoDeduct)} className={`w-20 h-10 rounded-full transition-all relative ${settings.autoDeduct ? 'bg-emerald-500 shadow-[0_0_30px_rgba(16,185,129,0.5)]' : 'bg-zinc-900 shadow-inner'}`}><div className={`absolute top-1.5 w-7 h-7 rounded-full bg-white shadow-2xl transition-all ${settings.autoDeduct ? 'left-11' : 'left-2'}`} /></button></div>
        <div className="h-px bg-zinc-900/50 italic" />
        <div className="flex items-center justify-between gap-12 text-white leading-none group italic"><div className="space-y-3 italic"><h4 className="font-black text-3xl italic uppercase tracking-tighter text-white leading-none group-hover:tracking-normal transition-all italic leading-none uppercase tracking-widest font-black uppercase italic leading-none italic tracking-tighter italic">Watermark Latar</h4><p className="text-[11px] text-zinc-600 font-bold uppercase tracking-[0.3em] italic leading-relaxed tracking-widest max-w-sm italic uppercase tracking-widest opacity-60 italic leading-relaxed tracking-widest">Paparan logo perniagaan secara artistik di latar belakang sistem.</p></div><button onClick={() => update('watermark', !settings.watermark)} className={`w-20 h-10 rounded-full transition-all relative ${settings.watermark ? 'bg-white shadow-[0_0_30px_rgba(255,255,255,0.4)]' : 'bg-zinc-900 shadow-inner'}`}><div className={`absolute top-1.5 w-7 h-7 rounded-full bg-black shadow-2xl transition-all ${settings.watermark ? 'left-11' : 'left-2'}`} /></button></div>
      </div>
      <div className="pt-32 text-center opacity-30 space-y-8 text-white italic"><p className="text-[11px] font-black uppercase tracking-[1.5em] italic italic italic leading-none tracking-widest animate-pulse italic uppercase tracking-widest leading-none uppercase tracking-widest font-black italic">KMY BRU • PRO PRODUCTION V5.0 FINAL EDITION</p><div className="flex items-center justify-center gap-4 text-white uppercase italic tracking-widest font-black italic uppercase"><CheckCircle2 size={12} className="text-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]" /><p className="font-mono text-[9px] tracking-[0.5em] uppercase opacity-40 italic text-white font-black italic">{user.uid}</p></div></div>
    </div>
  );
}

// --- AUTH PAGE ---
function AuthPage() {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const handleAuth = async (e) => {
    e.preventDefault();
    setError('');
    try {
      if (isLogin) await signInWithEmailAndPassword(auth, email, password);
      else await createUserWithEmailAndPassword(auth, email, password);
    } catch (err) { 
      let msg = err.message.toUpperCase();
      if(msg.includes('ADMIN-RESTRICTED-OPERATION')) msg = 'LOGIN ANONIM DISEKAT. SILA DAFTAR AKAUN MANUAL.';
      setError(msg); 
    }
  };
  return (
    <div className="min-h-screen bg-black flex items-center justify-center p-12 text-white overflow-hidden relative italic">
      <div className="absolute inset-0 bg-gradient-to-br from-zinc-900/20 to-black pointer-events-none z-0 italic" />
      <div className="w-full max-w-sm space-y-20 animate-in fade-in zoom-in-95 duration-1000 relative z-10 italic">
        <div className="text-center space-y-10 group italic">
           <div className="w-28 h-28 bg-white rounded-[2.5rem] mx-auto flex items-center justify-center rotate-6 shadow-[0_20px_80px_rgba(255,255,255,0.3)] transition-all group-hover:rotate-0 group-hover:scale-110 duration-700 shadow-2xl italic"><Coffee className="text-black" size={56} /></div>
           <div className="italic text-white"><h1 className="text-7xl font-black italic tracking-tighter text-white uppercase italic leading-none hover:tracking-normal transition-all cursor-default uppercase italic tracking-widest font-black italic">KMY BRU</h1><p className="text-zinc-800 text-[10px] font-black uppercase tracking-[0.8em] mt-8 italic opacity-40 leading-none italic uppercase tracking-[0.8em] font-black italic">Cloud Control Center</p></div>
        </div>
        <form onSubmit={handleAuth} className="space-y-8 italic">
          <input type="email" placeholder="E-MEL" className={`w-full ${THEME.input} rounded-[2rem] px-10 py-6 text-[11px] font-black uppercase tracking-[0.4em] outline-none shadow-2xl text-center focus:scale-105 transition-transform uppercase italic tracking-widest font-black leading-none italic text-white italic`} value={email} onChange={e => setEmail(e.target.value)} required />
          <input type="password" placeholder="PASSWORD" className={`w-full ${THEME.input} rounded-[2rem] px-10 py-6 text-[11px] font-black tracking-[0.4em] outline-none shadow-2xl text-center focus:scale-105 transition-transform uppercase italic tracking-widest font-black leading-none italic text-white italic`} value={password} onChange={e => setPassword(e.target.value)} required />
          {error && <p className="text-rose-500 text-[10px] font-black text-center uppercase tracking-[0.3em] animate-bounce italic leading-relaxed uppercase tracking-widest italic font-black italic">{error}</p>}
          <button type="submit" className="w-full bg-white text-black font-black py-7 rounded-[2rem] shadow-[0_25px_60px_rgba(255,255,255,0.25)] hover:bg-zinc-200 transition-all uppercase tracking-[0.5em] text-[11px] active:scale-95 shadow-2xl leading-none italic font-black uppercase tracking-widest italic font-black">
             {isLogin ? 'ENTER SYSTEM' : 'CREATE ACCOUNT'}
          </button>
        </form>
        <p className="text-center text-zinc-800 text-[10px] uppercase tracking-[0.4em] font-black italic leading-none uppercase italic tracking-widest leading-loose italic font-black italic text-zinc-500">
           {isLogin ? "No Access? " : "Registered? "}
           <button onClick={() => setIsLogin(!isLogin)} className="text-white hover:underline transition-all ml-4 uppercase italic tracking-widest underline-offset-[10px] font-black decoration-zinc-800 hover:decoration-white italic uppercase tracking-widest font-black italic text-white italic font-black">
              {isLogin ? 'Request' : 'Login'}
           </button>
        </p>
      </div>
    </div>
  );
}
