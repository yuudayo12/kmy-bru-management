<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KMY BRU | Master Control</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Recharts Dependencies -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Professional Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #000000;
            --card: #0c0c0c;
            --border: #1a1a1a;
            --accent: #ffffff;
        }
        body {
            background-color: var(--bg);
            color: #e5e7eb;
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        .header-text {
            font-weight: 800;
            letter-spacing: -0.01em;
            text-transform: uppercase;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #000; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #222; border-radius: 10px; }
        
        .fade-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }

        .bru-input {
            background: #080808;
            border: 1px solid #222;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
            color: white;
            outline: none;
            width: 100%;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        .bru-input:focus { border-color: white; background: #000; }
        
        table { border-collapse: separate; border-spacing: 0 4px; width: 100%; }
        tr { background: #080808; }
        td, th { padding: 0.85rem 1rem; text-align: left; }
        td:first-child, th:first-child { border-radius: 0.75rem 0 0 0.75rem; }
        td:last-child, th:last-child { border-radius: 0 0.75rem 0.75rem 0; }

        .btn-action {
            transition: all 0.2s;
        }
        .btn-action:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo } = React;
        const { XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar, AreaChart, Area } = window.Recharts;

        // --- FIREBASE CORE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, Timestamp, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB8EE6iavqDKXJdmgLpOD6kMVYsskHu56w",
            authDomain: "kmy-bru-manager.firebaseapp.com",
            projectId: "kmy-bru-manager",
            storageBucket: "kmy-bru-manager.firebasestorage.app",
            messagingSenderId: "176073299379",
            appId: "1:176073299379:web:6c5eeee23008d8f09b27c6"
        };

        const fApp = initializeApp(firebaseConfig);
        const auth = getAuth(fApp);
        const db = getFirestore(fApp);
        const activeAppId = "kmy-bru-master-v7"; // ID Sistem Konsisten

        const formatRM = (v) => new Intl.NumberFormat('en-MY', { style: 'currency', currency: 'MYR' }).format(v || 0);

        // --- UI HELPERS ---

        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex justify-center items-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in">
                    <div className="fixed inset-0 -z-10" onClick={onClose}></div>
                    <div className="bg-[#0c0c0c] border border-[#1a1a1a] relative w-full max-w-3xl rounded-[1.5rem] shadow-2xl flex flex-col max-h-[90vh]">
                        <div className="flex items-center justify-between p-5 border-b border-[#1a1a1a]">
                            <h3 className="text-md header-text text-white">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-all text-zinc-500 hover:text-white">
                                <Icon name="x" size={20} />
                            </button>
                        </div>
                        <div className="p-6 text-white overflow-y-auto custom-scrollbar">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTS ---

        function AuthPage() {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isLogin) await signInWithEmailAndPassword(auth, email, password);
                    else await createUserWithEmailAndPassword(auth, email, password);
                } catch (err) { setError(err.message.toUpperCase()); }
            };

            return (
                <div className="min-h-screen bg-black flex items-center justify-center p-8">
                    <div className="w-full max-w-sm space-y-10 fade-in">
                        <div className="text-center space-y-3">
                            <div className="w-16 h-16 bg-white rounded-2xl mx-auto flex items-center justify-center shadow-2xl">
                                <Icon name="coffee" className="text-black" size={32} />
                            </div>
                            <h1 className="text-3xl header-text text-white">KMY BRU</h1>
                            <p className="text-zinc-600 text-[9px] header-text tracking-[0.4em]">Master Dashboard</p>
                        </div>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <input type="email" placeholder="E-MEL" className="bru-input text-center" value={email} onChange={e => setEmail(e.target.value)} required />
                            <input type="password" placeholder="PASSWORD" className="bru-input text-center" value={password} onChange={e => setPassword(e.target.value)} required />
                            {error && <p className="text-red-500 text-[10px] font-bold text-center uppercase tracking-wider">{error}</p>}
                            <button type="submit" className="w-full bg-white text-black py-4 rounded-xl header-text text-xs hover:bg-zinc-200 transition-all btn-action">
                                {isLogin ? 'LOG MASUK' : 'DAFTAR AKSES'}
                            </button>
                        </form>
                        <button onClick={() => setIsLogin(!isLogin)} className="w-full text-zinc-600 text-[10px] header-text hover:text-white transition-colors">
                            {isLogin ? "TIADA AKAUN? DAFTAR" : "SUDAH ADA AKAUN? MASUK"}
                        </button>
                    </div>
                </div>
            );
        }

        function DashboardView({ sales }) {
            const stats = useMemo(() => {
                const profit = sales.reduce((acc, s) => acc + (s.totalProfit || 0), 0);
                const revenue = sales.reduce((acc, s) => acc + (s.totalPrice || 0), 0);
                return { profit, revenue, count: sales.length };
            }, [sales]);

            return (
                <div className="space-y-8 fade-in">
                    <header><p className="text-zinc-500 header-text text-[10px] mb-1 uppercase tracking-widest leading-none">Intelligence</p><h2 className="text-6xl header-text leading-none italic">OVERVIEW</h2></header>
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div className="bg-[#080808] border border-[#111] p-8 rounded-2xl">
                            <p className="text-zinc-600 header-text text-[9px] mb-2 tracking-widest uppercase">Untung Bersih</p>
                            <h4 className="text-3xl header-text text-emerald-500 leading-none">{formatRM(stats.profit)}</h4>
                        </div>
                        <div className="bg-[#080808] border border-[#111] p-8 rounded-2xl">
                            <p className="text-zinc-600 header-text text-[9px] mb-2 tracking-widest uppercase">Hasil Jualan</p>
                            <h4 className="text-3xl header-text text-white leading-none">{formatRM(stats.revenue)}</h4>
                        </div>
                        <div className="bg-[#080808] border border-[#111] p-8 rounded-2xl">
                            <p className="text-zinc-600 header-text text-[9px] mb-2 tracking-widest uppercase">Bil. Order</p>
                            <h4 className="text-3xl header-text text-zinc-500 leading-none">{stats.count}</h4>
                        </div>
                    </div>
                </div>
            );
        }

        function SalesPage({ user, sales, products, ingredients, recipes, settings }) {
            const [isOpen, setIsOpen] = useState(false);
            
            const handleOrder = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const pId = fd.get('pId');
                const qty = parseInt(fd.get('qty')) || 0;
                const product = products.find(p => p.id === pId);
                const recipe = recipes.find(r => r.productId === pId);
                if (!product) return;

                let cost = 0;
                if (recipe) {
                    recipe.ingredients.forEach(ri => {
                        const ing = ingredients.find(i => i.id === ri.ingredientId);
                        if (ing) cost += (ri.quantityPerBottle * (ing.avgUnitCostRM || 0));
                    });
                }
                
                const base = ['artifacts', activeAppId, 'users', user.uid, 'sales'];
                await addDoc(collection(db, ...base), {
                    productName: product.name, quantitySold: qty, totalPrice: qty * product.price, totalCost: qty * cost, totalProfit: (qty * product.price) - (qty * cost), timestamp: Timestamp.now()
                });

                if (settings.autoDeduct && recipe) {
                    for (const ri of recipe.ingredients) {
                        await updateDoc(doc(db, 'artifacts', activeAppId, 'users', user.uid, 'ingredients', ri.ingredientId), {
                            currentStock: increment(-(ri.quantityPerBottle * qty))
                        });
                    }
                }
                setIsOpen(false);
            };

            const remove = async (id) => {
                if (!confirm("Padam rekod ini?")) return;
                await deleteDoc(doc(db, 'artifacts', activeAppId, 'users', user.uid, 'sales', id));
            };

            return (
                <div className="space-y-8 fade-in">
                    <header className="flex justify-between items-end">
                        <div><p className="text-zinc-500 header-text text-[10px] mb-1">Live</p><h2 className="text-6xl header-text leading-none italic uppercase">JUALAN</h2></div>
                        <button onClick={() => setIsOpen(true)} className="bg-white text-black px-6 py-3 rounded-xl header-text text-[10px] btn-action flex items-center gap-2"><Icon name="plus" size={16}/> Baru</button>
                    </header>
                    <div className="overflow-x-auto">
                        <table className="w-full">
                            <thead><tr className="text-zinc-600 header-text text-[9px] italic"><th>Produk / Masa</th><th className="text-center">Qty</th><th className="text-right">Profit</th><th className="text-center w-16">Padam</th></tr></thead>
                            <tbody>
                                {sales.sort((a,b) => b.timestamp - a.timestamp).map(s => (
                                    <tr key={s.id}>
                                        <td><div className="font-bold text-sm uppercase italic">{s.productName}</div><div className="text-[9px] opacity-40 mt-1 uppercase">{s.timestamp?.toDate().toLocaleString()}</div></td>
                                        <td className="text-center font-bold text-xl">{s.quantitySold}</td>
                                        <td className="text-right font-bold text-lg text-emerald-500">{formatRM(s.totalProfit)}</td>
                                        <td className="text-center">
                                            <button onClick={() => remove(s.id)} className="text-zinc-800 hover:text-rose-500 p-2"><Icon name="trash-2" size={16}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <Modal isOpen={isOpen} onClose={() => setIsOpen(false)} title="Pendaftaran Pesanan">
                        <form onSubmit={handleOrder} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="space-y-1">
                                <label className="text-[9px] header-text text-zinc-500 uppercase">Pilih Menu Produk</label>
                                <select name="pId" required className="bru-input italic font-bold">
                                    <option value="">Sila Pilih...</option>
                                    {products.map(p => <option key={p.id} value={p.id} className="text-black">{p.name} ({formatRM(p.price)})</option>)}
                                </select>
                            </div>
                            <div className="space-y-1">
                                <label className="text-[9px] header-text text-zinc-500 uppercase text-center block">Unit</label>
                                <input name="qty" type="number" defaultValue={1} min={1} required className="bru-input text-center font-black" />
                            </div>
                            <div className="md:col-span-2 pt-4">
                                <button type="submit" className="w-full bg-white text-black py-4 rounded-xl header-text text-xs btn-action italic">Sahkan Jualan</button>
                            </div>
                        </form>
                    </Modal>
                </div>
            );
        }

        function ProductsView({ user, products, ingredients, recipes }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [activeRecipe, setActiveRecipe] = useState(null);

            const remove = async (id) => {
                if (!confirm("Padam menu ini?")) return;
                await deleteDoc(doc(db, 'artifacts', activeAppId, 'users', user.uid, 'products', id));
            };

            return (
                <div className="space-y-8 fade-in">
                    <header className="flex justify-between items-end">
                        <div><p className="text-zinc-500 header-text text-[10px] mb-1">Catalog</p><h2 className="text-6xl header-text leading-none italic uppercase">MENU</h2></div>
                        <button onClick={() => setIsModalOpen(true)} className="bg-white text-black px-6 py-3 rounded-xl header-text text-[10px] btn-action italic uppercase font-bold">Tambah</button>
                    </header>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {products.map(p => (
                            <div key={p.id} className="bg-[#080808] border border-[#111] p-6 rounded-2xl space-y-4 hover:border-white transition-all group">
                                <h4 className="text-lg header-text uppercase italic leading-tight">{p.name}</h4>
                                <div className="flex justify-between items-center pt-3 border-t border-[#111]">
                                    <p className="text-zinc-500 text-[10px] font-bold">{p.volume}ml â€¢ {formatRM(p.price)}</p>
                                    <div className="flex gap-2">
                                        <button onClick={() => setActiveRecipe(recipes.find(r => r.productId === p.id) || { productId: p.id, ingredients: [] })} className="bg-zinc-900 p-2 rounded-lg hover:bg-white hover:text-black transition-all"><Icon name="book-open" size={14}/></button>
                                        <button onClick={() => remove(p.id)} className="bg-zinc-900 p-2 rounded-lg text-rose-500 hover:bg-rose-500 hover:text-white transition-all"><Icon name="trash-2" size={14}/></button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Menu Baru">
                        <form onSubmit={async (e) => {
                            e.preventDefault();
                            const fd = new FormData(e.target);
                            await addDoc(collection(db, 'artifacts', activeAppId, 'users', user.uid, 'products'), {
                                name: fd.get('n').toUpperCase(), volume: parseFloat(fd.get('v')), price: parseFloat(fd.get('p'))
                            });
                            setIsModalOpen(false);
                        }} className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div className="md:col-span-1"><label className="text-[9px] text-zinc-600 uppercase">Nama</label><input name="n" className="bru-input font-bold" required /></div>
                            <div><label className="text-[9px] text-zinc-600 uppercase">Saiz (ML)</label><input name="v" type="number" className="bru-input text-center" required /></div>
                            <div><label className="text-[9px] text-zinc-600 uppercase">Harga (RM)</label><input name="p" type="number" step="0.1" className="bru-input text-center" required /></div>
                            <div className="md:col-span-3 pt-2"><button type="submit" className="w-full bg-white text-black py-4 rounded-xl header-text text-xs btn-action italic">Simpan Katalog</button></div>
                        </form>
                    </Modal>

                    <Modal isOpen={!!activeRecipe} onClose={() => setActiveRecipe(null)} title={`Formula: ${products.find(p => p.id === activeRecipe?.productId)?.name}`}>
                        <div className="space-y-6">
                            <div className="flex gap-2 items-end">
                                <div className="flex-1"><label className="text-[9px] text-zinc-600 uppercase block mb-1">Tambah Bahan Mentah</label>
                                <select id="add-ing" className="bru-input uppercase text-xs font-bold italic">
                                    <option value="">Pilih Dari Gudang...</option>
                                    {ingredients.map(i => <option key={i.id} value={i.id} className="text-black">{i.name}</option>)}
                                </select></div>
                                <button onClick={async () => {
                                    const id = document.getElementById('add-ing').value; if(!id) return;
                                    const ing = ingredients.find(i => i.id === id);
                                    const newIngs = [...activeRecipe.ingredients, { ingredientId: id, name: ing.name, quantityPerBottle: 0, unit: ing.unit }];
                                    const upd = { ...activeRecipe, ingredients: newIngs };
                                    const base = ['artifacts', activeAppId, 'users', user.uid, 'recipes'];
                                    if(activeRecipe.id) await updateDoc(doc(db, ...base, activeRecipe.id), upd);
                                    else { const ref = await addDoc(collection(db, ...base), upd); setActiveRecipe({...upd, id: ref.id}); }
                                    setActiveRecipe(upd);
                                }} className="bg-white text-black px-6 py-3 rounded-xl header-text text-[10px] btn-action">Tambah</button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {activeRecipe?.ingredients.map((ri, idx) => (
                                    <div key={idx} className="flex items-center gap-3 bg-zinc-900/40 p-4 rounded-xl border border-zinc-800">
                                        <div className="flex-1 text-[11px] font-bold uppercase italic">{ri.name}</div>
                                        <input type="number" value={ri.quantityPerBottle} step="0.1" onChange={async (e) => {
                                            const val = parseFloat(e.target.value) || 0;
                                            const newIngs = activeRecipe.ingredients.map((it, i) => i === idx ? {...it, quantityPerBottle: val} : it);
                                            const upd = {...activeRecipe, ingredients: newIngs};
                                            setActiveRecipe(upd);
                                            await updateDoc(doc(db, 'artifacts', activeAppId, 'users', user.uid, 'recipes', activeRecipe.id), upd);
                                        }} className="bg-black border border-zinc-800 w-20 p-2 rounded-lg text-sm text-center outline-none italic" />
                                        <span className="text-[9px] opacity-40 uppercase">{ri.unit}</span>
                                        <button onClick={async () => {
                                            const newIngs = activeRecipe.ingredients.filter((_, i) => i !== idx);
                                            const upd = {...activeRecipe, ingredients: newIngs};
                                            setActiveRecipe(upd);
                                            await updateDoc(doc(db, 'artifacts', activeAppId, 'users', user.uid, 'recipes', activeRecipe.id), upd);
                                        }} className="text-zinc-800 hover:text-rose-500 transition-colors"><Icon name="trash-2" size={16} /></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        }

        function InventoryView({ user, ingredients }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const remove = async (id) => {
                if (!confirm("Padam bahan mentah ini?")) return;
                await deleteDoc(doc(db, 'artifacts', activeAppId, 'users', user.uid, 'ingredients', id));
            };

            return (
                <div className="space-y-8 fade-in">
                    <header className="flex justify-between items-end">
                        <div><p className="text-zinc-500 header-text text-[10px] mb-1">Supplies</p><h2 className="text-6xl header-text leading-none italic uppercase">GUDANG</h2></div>
                        <button onClick={() => setIsModalOpen(true)} className="bg-white text-black px-6 py-3 rounded-xl header-text text-[10px] btn-action italic font-bold">Baru</button>
                    </header>
                    <div className="overflow-x-auto">
                        <table className="w-full">
                            <thead><tr className="text-zinc-600 header-text text-[9px] italic"><th>Bahan</th><th className="text-center">Baki</th><th className="text-right">Unit Cost</th><th className="text-center w-16">Padam</th></tr></thead>
                            <tbody>
                                {ingredients.map(i => (
                                    <tr key={i.id}>
                                        <td className="font-bold text-lg uppercase italic leading-none">{i.name}</td>
                                        <td className="text-center text-3xl font-black italic">{i.currentStock}<span className="text-[10px] opacity-20 ml-1 uppercase font-bold">{i.unit}</span></td>
                                        <td className="text-right text-zinc-500 font-semibold italic">{formatRM(i.avgUnitCostRM)}</td>
                                        <td className="text-center">
                                            <button onClick={() => remove(i.id)} className="text-zinc-800 hover:text-rose-500 p-2 transition-colors"><Icon name="trash-2" size={18}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Pendaftaran Bahan">
                        <form onSubmit={async (e) => {
                            e.preventDefault();
                            const fd = new FormData(e.target);
                            await addDoc(collection(db, 'artifacts', activeAppId, 'users', user.uid, 'ingredients'), {
                                name: fd.get('n').toUpperCase(), category: fd.get('c'), unit: fd.get('u'), currentStock: parseFloat(fd.get('s')) || 0, avgUnitCostRM: parseFloat(fd.get('k')) || 0
                            });
                            setIsModalOpen(false);
                        }} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="md:col-span-2"><label className="text-[9px] text-zinc-600 uppercase">Nama Bahan Mentah</label><input name="n" className="bru-input italic font-bold uppercase" required /></div>
                            <div><label className="text-[9px] text-zinc-600 uppercase">Unit</label><select name="u" className="bru-input font-bold italic"><option value="ml">ML</option><option value="g">G</option><option value="pcs">PCS</option></select></div>
                            <div><label className="text-[9px] text-zinc-600 uppercase">Stok Asal</label><input name="s" type="number" step="0.01" className="bru-input text-center" required /></div>
                            <div className="md:col-span-2"><label className="text-[9px] text-zinc-600 uppercase">Kos Purata Seunit (RM)</label><input name="k" type="number" step="0.0001" className="bru-input text-center" required /></div>
                            <button type="submit" className="md:col-span-2 bg-white text-black py-4 rounded-xl header-text text-xs btn-action mt-2 italic">Simpan Data</button>
                        </form>
                    </Modal>
                </div>
            );
        }

        function PurchasesView({ user, purchases, ingredients }) {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const remove = async (id) => {
                if (!confirm("Padam rekod pembelian?")) return;
                await deleteDoc(doc(db, 'artifacts', activeAppId, 'users', user.uid, 'purchases', id));
            };

            return (
                <div className="space-y-8 fade-in">
                    <header className="flex justify-between items-end">
                        <div><p className="text-zinc-500 header-text text-[10px] mb-1">Injection</p><h2 className="text-6xl header-text leading-none italic uppercase">PEMBELIAN</h2></div>
                        <button onClick={() => setIsModalOpen(true)} className="bg-white text-black px-6 py-3 rounded-xl header-text text-[10px] btn-action italic font-bold">Baru</button>
                    </header>
                    <div className="overflow-x-auto">
                        <table className="w-full">
                            <thead><tr className="text-zinc-600 header-text text-[9px] italic"><th>Tarikh</th><th>Item</th><th className="text-right">RM</th><th className="text-center w-16">Padam</th></tr></thead>
                            <tbody>
                                {purchases.sort((a,b) => b.timestamp - a.timestamp).map(p => (
                                    <tr key={p.id}>
                                        <td className="text-zinc-700 text-[10px] font-mono uppercase leading-none">{p.timestamp?.toDate().toLocaleDateString()}</td>
                                        <td className="font-bold text-lg uppercase italic leading-none">{p.ingName} <span className="text-[9px] opacity-20 ml-2">({p.qty}{p.unit})</span></td>
                                        <td className="text-right font-bold text-xl leading-none">{formatRM(p.cost)}</td>
                                        <td className="text-center">
                                            <button onClick={() => remove(p.id)} className="text-zinc-900 hover:text-rose-500 p-2 transition-colors"><Icon name="trash-2" size={16}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Log Pembelian Stok">
                        <form onSubmit={async (e) => {
                            e.preventDefault();
                            const f = new FormData(e.target);
                            const iId = f.get('id'); const q = parseFloat(f.get('q')); const c = parseFloat(f.get('c'));
                            const ing = ingredients.find(i => i.id === iId);
                            if (!ing) return;
                            const nS = ing.currentStock + q;
                            const nA = (ing.currentStock * ing.avgUnitCostRM + c) / nS;
                            const base = ['artifacts', activeAppId, 'users', user.uid];
                            await addDoc(collection(db, ...base, 'purchases'), { ingName: ing.name, qty: q, cost: c, unit: ing.unit, timestamp: Timestamp.now() });
                            await updateDoc(doc(db, ...base, 'ingredients', iId), { currentStock: increment(q), avgUnitCostRM: nA });
                            setIsModalOpen(false);
                        }} className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div className="md:col-span-2">
                                <label className="text-[9px] text-zinc-600 uppercase">Pilih Bahan</label>
                                <select name="id" required className="bru-input uppercase italic font-bold">
                                    <option value="">Pilih Dari Inventori...</option>
                                    {ingredients.map(i => <option key={i.id} value={i.id} className="text-black">{i.name}</option>)}
                                </select>
                            </div>
                            <div><label className="text-[9px] text-zinc-600 uppercase">Kuantiti</label><input name="q" type="number" step="0.01" className="bru-input text-center" required /></div>
                            <div><label className="text-[9px] text-zinc-600 uppercase">Harga Total (RM)</label><input name="c" type="number" step="0.01" className="bru-input text-center" required /></div>
                            <button type="submit" className="md:col-span-2 bg-white text-black py-4 rounded-xl header-text text-xs btn-action mt-2 italic">Daftar Transaksi</button>
                        </form>
                    </Modal>
                </div>
            );
        }

        // --- MASTER APP ---

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            
            const [products, setProducts] = useState([]);
            const [ingredients, setIngredients] = useState([]);
            const [recipes, setRecipes] = useState([]);
            const [sales, setSales] = useState([]);
            const [purchases, setPurchases] = useState([]);
            const [settings, setSettings] = useState({ autoDeduct: true, watermark: true, logoUrl: null });

            useEffect(() => {
                return onAuthStateChanged(auth, u => { setUser(u); setLoading(false); });
            }, []);

            useEffect(() => {
                if (!user) return;
                const base = ['artifacts', activeAppId, 'users', user.uid];
                const unsub = [
                    onSnapshot(collection(db, ...base, 'products'), s => setProducts(s.docs.map(d => ({id: d.id, ...d.data()})))),
                    onSnapshot(collection(db, ...base, 'ingredients'), s => setIngredients(s.docs.map(d => ({id: d.id, ...d.data()})))),
                    onSnapshot(collection(db, ...base, 'recipes'), s => setRecipes(s.docs.map(d => ({id: d.id, ...d.data()})))),
                    onSnapshot(collection(db, ...base, 'sales'), s => setSales(s.docs.map(d => ({id: d.id, ...d.data()})))),
                    onSnapshot(collection(db, ...base, 'purchases'), s => setPurchases(s.docs.map(d => ({id: d.id, ...d.data()})))),
                    onSnapshot(doc(db, ...base, 'settings', 'config'), s => s.exists() && setSettings(s.data()))
                ];
                return () => unsub.forEach(f => f());
            }, [user]);

            if (loading) return (
                <div className="min-h-screen bg-black flex flex-col items-center justify-center text-white">
                    <div className="w-8 h-8 border-t-2 border-white rounded-full animate-spin mb-4"></div>
                    <p className="text-[8px] header-text opacity-30 italic uppercase tracking-[0.4em]">Master Session Authenticating</p>
                </div>
            );

            if (!user) return <AuthPage />;

            const NavItem = ({ icon, label, id }) => (
                <button onClick={() => { setView(id); setSidebarOpen(false); }} className={`flex items-center gap-4 px-6 py-4 rounded-xl transition-all w-full text-left ${view === id ? 'bg-white text-black shadow-2xl scale-[1.02]' : 'text-zinc-600 hover:text-white hover:bg-zinc-900'}`}>
                    <Icon name={icon} size={18} />
                    <span className="text-[10px] header-text tracking-widest italic">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen bg-black text-white flex flex-col lg:flex-row overflow-x-hidden selection:bg-white selection:text-black">
                    <aside className="hidden lg:flex flex-col w-64 fixed h-full border-r border-[#111] p-6 z-[60] bg-black">
                        <div className="mb-10 flex items-center gap-3 px-2">
                            <div className="w-8 h-8 bg-white rounded-xl flex items-center justify-center rotate-3 shadow-2xl"><Icon name="coffee" className="text-black" size={20} /></div>
                            <h1 className="text-lg header-text text-white italic">KMY BRU</h1>
                        </div>
                        <nav className="flex-1 space-y-1">
                            <NavItem icon="layout-dashboard" label="Dashboard" id="dashboard" />
                            <NavItem icon="shopping-cart" label="Jualan" id="sales" />
                            <NavItem icon="book-open" label="Katalog" id="products" />
                            <NavItem icon="package" label="Inventori" id="inventory" />
                            <NavItem icon="receipt" label="Pembelian" id="purchases" />
                        </nav>
                        <button onClick={() => signOut(auth)} className="mt-8 p-3 border border-zinc-900 rounded-lg text-[8px] header-text text-zinc-800 hover:text-rose-500 hover:border-rose-500/20 transition-all uppercase italic font-bold">Sign Out</button>
                    </aside>

                    <header className="lg:hidden flex items-center justify-between p-6 border-b border-[#111] sticky top-0 bg-black/95 backdrop-blur-xl z-[60] w-full text-white">
                        <div className="flex items-center gap-3"><Icon name="coffee" size={20} /><h1 className="header-text text-lg italic uppercase">KMY BRU</h1></div>
                        <button onClick={() => setSidebarOpen(true)} className="p-2 bg-zinc-950 rounded-lg border border-[#111]"><Icon name="menu" size={20} /></button>
                    </header>

                    {sidebarOpen && (
                        <div className="lg:hidden fixed inset-0 bg-black z-[200] p-10 flex flex-col fade-in overflow-y-auto italic">
                            <div className="flex justify-between items-center mb-16"><h1 className="text-3xl header-text italic uppercase">MENU</h1><button onClick={() => setSidebarOpen(false)} className="p-3 bg-zinc-900 rounded-lg"><Icon name="x" size={24} /></button></div>
                            <nav className="flex-1 space-y-4">
                                <NavItem icon="layout-dashboard" label="Dashboard" id="dashboard" />
                                <NavItem icon="shopping-cart" label="Jualan" id="sales" />
                                <NavItem icon="book-open" label="Katalog" id="products" />
                                <NavItem icon="package" label="Inventori" id="inventory" />
                                <NavItem icon="receipt" label="Pembelian" id="purchases" />
                            </nav>
                        </div>
                    )}

                    <main className="lg:ml-64 flex-1 p-6 lg:p-12 pb-32 min-h-screen italic uppercase leading-none">
                        <div className="max-w-6xl mx-auto">
                            {view === 'dashboard' && <DashboardView sales={sales} />}
                            {view === 'sales' && <SalesPage user={user} sales={sales} products={products} ingredients={ingredients} recipes={recipes} settings={settings} />}
                            {view === 'products' && <ProductsView user={user} products={products} ingredients={ingredients} recipes={recipes} />}
                            {view === 'inventory' && <InventoryView user={user} ingredients={ingredients} />}
                            {view === 'purchases' && <PurchasesView user={user} purchases={purchases} ingredients={ingredients} />}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('app'));
        root.render(<App />);
    </script>
</body>
</html>
